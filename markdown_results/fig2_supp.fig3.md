---
title: "Generation of main Fig. 2 and Supp. Fig. 3"
subtitle: "Data of Zhu et al. https://doi.org/10.7150%2Fthno.48206"
author: "Aram Safrastyan"
date: "19 September, 2022"
output:
  html_document: 
    keep_md: yes
    toc: TRUE
    code_folding: hide
    number_sections: TRUE
---
            


<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>



# load libraries
***


```r
library(dplyr)
library(cowplot)
library(ggplot2)
library(forcats)
library(scales)
library(ReactomePA)
library(org.Hs.eg.db)
library(magick)
library(clusterProfiler)
library(ragg)
library(AnnotationDbi)
```

# Generation of Fig. 2
***


```r
#load cfRNA WGCNA results
load("./cfrna/results/wgcna_main/cfwgcna.RData")
#get gene names and transfer to ENTREZID
module_genes<-data.frame( module = cfmergedcolors, gene = colnames(cfrna_wgcna_input)) 
module_genes_entrez<-AnnotationDbi::select(org.Hs.eg.db,
                              keys = module_genes$gene,
                              keytype = "SYMBOL",
                              columns = c("SYMBOL","ENTREZID")) %>% dplyr::left_join(module_genes,by=c("SYMBOL"="gene"))
#Reactome pathway enrichment analysis and visualization of module cf-turquoise
turq_genes<-module_genes_entrez %>% dplyr::filter(module=="cf-turquoise") %>% na.omit() %>%
  dplyr::select(ENTREZID) %>% unique()
turq_reactome <- enrichPathway(gene= turq_genes$ENTREZID, pvalueCutoff = 0.05)
turq_reactome_df<-fortify(turq_reactome, showCategory = 10) 
turq_reactome_df$p.adjust<- -log10(as.numeric(turq_reactome_df$p.adjust))
turq_reactome_plot<-ggplot(turq_reactome_df, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +  
  geom_point(aes(size = Count, color = p.adjust))  +  
  scale_size_continuous(range = c(6, 10), breaks = pretty_breaks(n=3)) + 
  scale_colour_gradient(name = "-log10(p.adjust)", low="grey", high="black",  breaks=scales::extended_breaks()) +
  guides(size = guide_legend(reverse=T)) + 
  ylab(NULL) +  
  scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 30))  +   
  theme_bw(base_size = 26, base_family = "Arial", base_rect_size = 1, base_line_size = 1) +
  theme(plot.title = element_text(color="black", size=28, face="bold", hjust = 0.5),
        plot.subtitle = element_text(color="black", size=27, face="bold", hjust = 0.5)) +
  ggtitle("Reactome pathway enrichment analysis", subtitle = "cfRNA module cf-turquoise")
#Reactome pathway enrichment analysis and visualization of module cf-blue
blue_genes<-module_genes_entrez %>% dplyr::filter(module=="cf-blue") %>% na.omit() %>%
  dplyr::select(ENTREZID) %>% unique()
blue_reactome <- enrichPathway(gene= blue_genes$ENTREZID, pvalueCutoff = 0.05)
blue_reactome_df<-fortify(blue_reactome, showCategory = 10) 
blue_reactome_df$p.adjust<- -log10(as.numeric(blue_reactome_df$p.adjust))
blue_reactome_plot<-ggplot(blue_reactome_df, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +  
  geom_point(aes(size = Count, color = p.adjust))  +  
  scale_size_continuous(range = c(6, 10), breaks = pretty_breaks(n=3)) + 
  scale_colour_gradient(name = "-log10(p.adjust)", low="grey", high="black",  breaks=scales::extended_breaks()) +
  guides(size = guide_legend(reverse=T)) + 
  ylab(NULL) + 
  scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 30))  + 
  scale_x_continuous(labels =scales::label_number(accuracy = 0.001), breaks = scales::extended_breaks(n=3)) + 
  theme_bw(base_size = 26, base_family = "Arial", base_rect_size = 1, base_line_size = 1) + 
  theme(plot.title = element_text(color="black", size=28, face="bold", hjust = 0.5),
        plot.subtitle = element_text(color="black", size=27, face="bold", hjust = 0.5)) +
  ggtitle("Reactome pathway enrichment analysis", subtitle = "cfRNA module cf-blue")
#load module representations generated by Cytoscape
blue_module_plot<-draw_image("./cytoscape/edges_blue.png", width=.5, height=1, x=0, y=0.25, scale = 1.5) 
turq_module_plot<-draw_image("./cytoscape/edges_turquoise.png", width=.5, height=1, x=0.5, y=0.25, scale=1.5) 
#combine the plots in one image
fig2<-ggdraw() + blue_module_plot + turq_module_plot + draw_plot(blue_reactome_plot, x=0, y=0, width = .5, height=.5) + draw_plot(turq_reactome_plot, x=0.5, y=0, width = .5, height=.5) +  draw_plot_label(label = c("A", "B", "C", "D"), size = 42, x = c(0, 0.5, 0, 0.5), y = c(1, 1, 0.5, 0.5), family = "Arial") + draw_label("Network visualization", size=28, x=0.27, y=0.98, fontface = 'bold', fontfamily = "Arial") + draw_label("cfRNA module cf-blue", size=27, x=0.27, y=0.96, fontface = 'bold', fontfamily = "Arial") + draw_label("Network visualization", size=28, x=0.77, y=0.98, fontface = 'bold', fontfamily = "Arial") + draw_label("cfRNA module cf-turquoise", size=27, x=0.77, y=0.96, fontface = 'bold', fontfamily = "Arial") 
plot(fig2)
```

<img src="markdown_results/main-1.png" style="display: block; margin: auto;" />

```r
#save
ggsave(plot=fig2, file="./figures/main_figures/fig2.png", units = "mm", device = ragg::agg_png, height=150, width=180, scaling = 0.3, limitsize = FALSE)
```

# Generation of Supp Fig. 3
***


```r
#for Linux based systems
options(clusterProfiler.download.method = "wget")
#KEGG pathway enrichment analysis and visualization for module cf-turquoise
turq_kegg <- enrichKEGG(gene= turq_genes$ENTREZID, pvalueCutoff = 0.05, organism = 'hsa')
turq_kegg_df<-fortify(turq_kegg, showCategory = 10) 
turq_kegg_df$p.adjust<- -log10(as.numeric(turq_kegg_df$p.adjust))
turq_kegg_plot<-ggplot(turq_kegg_df, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +  
  geom_point(aes(size = Count, color = p.adjust))  +  
  scale_size_continuous(range = c(6, 10), breaks = pretty_breaks(n=3)) + 
  scale_colour_gradient(name = "-log10(p.adjust)", low="grey", high="black",  breaks=scales::extended_breaks()) +   
  guides(size = guide_legend(reverse=T)) + 
  ylab(NULL) + 
  ggtitle(paste0("KEGG pathway enrichment analysis", "\n", "cfRNA module cf-turquoise")) +  
  scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 30))  +   
  theme_bw(base_size = 26, base_family = "Arial", base_rect_size = 1, base_line_size = 1) + 
  theme(plot.title = element_text(color="black", size=28, face="bold", hjust = 0.5))
#WikiPathways pathway enrichment analysis and visualization for module cf-turquoise
turq_wp<-enrichWP(turq_genes$ENTREZID, organism = "Homo sapiens") 
turq_wp_df<-fortify(turq_wp, showCategory = 10) 
turq_wp_df$p.adjust<- -log10(as.numeric(turq_wp_df$p.adjust))
turq_wp_plot<-ggplot(turq_wp_df, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +  
  geom_point(aes(size = Count, color = p.adjust))  +  
  scale_size_continuous(range = c(6, 10), breaks = pretty_breaks(n=3)) + 
  scale_colour_gradient(name = "-log10(p.adjust)", low="grey", high="black",  breaks=scales::extended_breaks()) +  
  guides(size = guide_legend(reverse=T)) + 
  ylab(NULL) + 
  scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 30))  +   
  theme_bw(base_size = 26, base_family = "Arial", base_rect_size = 1, base_line_size = 1) +
  theme(plot.title = element_text(color="black", size=28, face="bold", hjust = 0.5),
        plot.subtitle = element_text(color="black", size=27, face="bold", hjust = 0.5)) +
  ggtitle("WikiPathways pathway enrichment analysis", subtitle =  "cfRNA module cf-turquoise")
#KEGG pathway enrichment analysis and visualization for module cf-blue
blue_genes<-module_genes_entrez %>% dplyr::filter(module=="cf-blue") %>% na.omit() %>%
  dplyr::select(ENTREZID) %>% unique()
blue_kegg <- enrichKEGG(gene= blue_genes$ENTREZID, pvalueCutoff = 0.05, organism = "hsa")
blue_kegg_df<-fortify(blue_kegg, showCategory = 10) 
blue_kegg_df$p.adjust<- -log10(as.numeric(blue_kegg_df$p.adjust))
blue_kegg_plot<-ggplot(blue_kegg_df, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +  
  geom_point(aes(size = Count, color = p.adjust))  +  
  scale_size_continuous(range = c(6, 10), breaks = pretty_breaks(n=3)) + 
  scale_colour_gradient(name = "-log10(p.adjust)", low="grey", high="black",  breaks=scales::extended_breaks()) +   
  guides(size = guide_legend(reverse=T)) + 
  ylab(NULL) + 
  scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 30))  + 
  scale_x_continuous(labels =scales::label_number(accuracy = 0.001), breaks = scales::extended_breaks(n=3)) +   
  theme_bw(base_size = 26, base_family = "Arial", base_rect_size = 1, base_line_size = 1) +
  theme(plot.title = element_text(color="black", size=28, face="bold", hjust = 0.5),
        plot.subtitle = element_text(color="black", size=27, face="bold", hjust = 0.5)) +
  ggtitle("KEGG pathway enrichment analysis", subtitle =  "cfRNA module cf-blue") 
#WikiPathways pathway enrichment analysis and visualization for module cf-blue
blue_wp<-enrichWP(blue_genes$ENTREZID, organism = "Homo sapiens") 
blue_wp_df<-fortify(blue_wp, showCategory = 10) 
blue_wp_df$p.adjust<- -log10(as.numeric(blue_wp_df$p.adjust))
blue_wp_plot<-ggplot(blue_wp_df, aes(x = GeneRatio, y = fct_reorder(Description, GeneRatio))) +  
  geom_point(aes(size = Count, color = p.adjust))  +  
  scale_size_continuous(range = c(6, 10), breaks = pretty_breaks(n=3)) + 
  scale_colour_gradient(name = "-log10(p.adjust)", low="grey", high="black",  breaks=scales::extended_breaks()) +   
  guides(size = guide_legend(reverse=T)) + 
  ylab(NULL) + 
  scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 30))  +   
  theme_bw(base_size = 26, base_family = "Arial", base_rect_size = 1, base_line_size = 1) + 
  theme(plot.title = element_text(color="black", size=28, face="bold", hjust = 0.5),
        plot.subtitle = element_text(color="black", size=27, face="bold", hjust = 0.5)) +
  ggtitle("WikiPathways pathway enrichment analysis", subtitle = "cfRNA module cf-blue") 
#combine plots
supp_fig3<-ggdraw() + draw_plot(blue_kegg_plot, x=0, y=0.5, width = .5, height=.5) + draw_plot(blue_wp_plot, x=0.5, y=0.5, width = .5, height=.5) + draw_plot(turq_kegg_plot, x=0, y=0, width = .5, height=.5) + draw_plot(turq_wp_plot, x=0.5, y=0, width = .5, height=.5) +  draw_plot_label(label = c("A", "B", "C", "D"), size = 42, x = c(0, 0.5, 0, 0.5), y = c(1, 1, 0.5, 0.5), family = "Arial")  
plot(supp_fig3)
```

<img src="markdown_results/supp-1.png" style="display: block; margin: auto;" />

```r
dir.create("./figures/supp_figures/")
#save
ggsave(plot=supp_fig3, file="./figures/supp_figures/supp_fig3.png", units = "mm", device = ragg::agg_png, height=150, width=180, scaling = 0.3, limitsize = FALSE)
```


```r
sessionInfo()
```

```
## R version 4.1.2 (2021-11-01)
## Platform: x86_64-conda-linux-gnu (64-bit)
## Running under: Debian GNU/Linux 9 (stretch)
## 
## Matrix products: default
## BLAS/LAPACK: /home/si48met/miniconda3/envs/cfwgcna_hcc/lib/libopenblasp-r0.3.21.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats4    stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
##  [1] ragg_1.2.2            clusterProfiler_4.2.0 magick_2.7.3         
##  [4] org.Hs.eg.db_3.14.0   AnnotationDbi_1.56.1  IRanges_2.28.0       
##  [7] S4Vectors_0.32.3      Biobase_2.54.0        BiocGenerics_0.40.0  
## [10] ReactomePA_1.38.0     scales_1.2.1          forcats_0.5.2        
## [13] ggplot2_3.3.6         cowplot_1.1.1         dplyr_1.0.10         
## 
## loaded via a namespace (and not attached):
##   [1] fgsea_1.20.0           colorspace_2.0-3       ggtree_3.2.0          
##   [4] ellipsis_0.3.2         qvalue_2.26.0          XVector_0.34.0        
##   [7] aplot_0.1.7            farver_2.1.1           graphlayouts_0.8.1    
##  [10] ggrepel_0.9.1          bit64_4.0.5            fansi_1.0.3           
##  [13] scatterpie_0.1.8       splines_4.1.2          cachem_1.0.6          
##  [16] GOSemSim_2.20.0        knitr_1.40             polyclip_1.10-0       
##  [19] jsonlite_1.8.0         GO.db_3.14.0           png_0.1-7             
##  [22] graph_1.72.0           ggforce_0.3.4          graphite_1.40.0       
##  [25] compiler_4.1.2         httr_1.4.4             backports_1.4.1       
##  [28] assertthat_0.2.1       Matrix_1.4-1           fastmap_1.1.0         
##  [31] lazyeval_0.2.2         cli_3.4.0              tweenr_2.0.2          
##  [34] htmltools_0.5.3        tools_4.1.2            igraph_1.3.0          
##  [37] gtable_0.3.1           glue_1.6.2             GenomeInfoDbData_1.2.7
##  [40] reshape2_1.4.4         DO.db_2.9              rappdirs_0.3.3        
##  [43] fastmatch_1.1-3        Rcpp_1.0.9             enrichplot_1.14.1     
##  [46] jquerylib_0.1.4        vctrs_0.4.1            Biostrings_2.62.0     
##  [49] ape_5.6-2              nlme_3.1-159           ggraph_2.0.6          
##  [52] xfun_0.32              stringr_1.4.1          lifecycle_1.0.1       
##  [55] DOSE_3.20.0            zlibbioc_1.40.0        MASS_7.3-58.1         
##  [58] tidygraph_1.2.2        reactome.db_1.77.0     parallel_4.1.2        
##  [61] RColorBrewer_1.1-3     yaml_2.3.5             memoise_2.0.1         
##  [64] gridExtra_2.3          downloader_0.4         ggfun_0.0.7           
##  [67] yulab.utils_0.0.5      sass_0.4.2             stringi_1.7.6         
##  [70] RSQLite_2.2.8          highr_0.9              tidytree_0.4.0        
##  [73] checkmate_2.1.0        BiocParallel_1.28.3    GenomeInfoDb_1.30.0   
##  [76] systemfonts_1.0.4      rlang_1.0.5            pkgconfig_2.0.3       
##  [79] bitops_1.0-7           evaluate_0.16          lattice_0.20-45       
##  [82] purrr_0.3.4            labeling_0.4.2         treeio_1.18.0         
##  [85] patchwork_1.1.2        shadowtext_0.1.2       bit_4.0.4             
##  [88] tidyselect_1.1.2       plyr_1.8.7             magrittr_2.0.3        
##  [91] R6_2.5.1               generics_0.1.3         DBI_1.1.3             
##  [94] pillar_1.8.1           withr_2.5.0            KEGGREST_1.34.0       
##  [97] RCurl_1.98-1.8         tibble_3.1.8           crayon_1.5.1          
## [100] utf8_1.2.2             rmarkdown_2.16         viridis_0.6.2         
## [103] grid_4.1.2             data.table_1.14.2      blob_1.2.3            
## [106] digest_0.6.29          tidyr_1.2.1            textshaping_0.3.6     
## [109] gridGraphics_0.5-1     munsell_0.5.0          viridisLite_0.4.1     
## [112] ggplotify_0.1.0        bslib_0.4.0
```
